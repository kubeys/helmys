HelmYS
======

Helm + YS - Support YS in Helm Templates


## Synopsis

Installation:

```
git clone https://github.com/kubeys/helmys
cd helmys
make install PREFIX=$HOME/.local
```

HelmYS Initialization (optional):
```
helmys init <chart>
```

Usage:
```
helm install <name> <chart> --post-renderer=helmys
# or:
helmys install <name> <chart>
```


## Description

The `helmys` (pronounced "helm wise") command provides a way to use YS
(YAMLScript) for Helm templating.

You can use as much or as little [YS](https://yamlscript.org) in your Helm
templates as you wish, replacing all the Go templating syntax or none of it.

Using YS for your templating needs is much cleaner than the standard Go
templating.
See this side by side template file comparison of a full conversion:
<https://yamlscript.org/helmys>.

In addition, templates that use YS exclusively for templating are valid YAML
files, thus various YAML tools like `yamllint` can be used on them.


## Setting It Up

Setting up HelmYS is very simple.

Just install `helmys` and `ys` (the YS CLI binary).
By default `make install` will also install `ys` (next to `helmys`) if it isn't
already installed.

If you plan to use YS code in your chart templates, then initialize your chart.
See below for more about that.

There are plenty of useful things you can do with HelmYS without initializing
your chart (or for charts that you don't own).


### Installing `helmys` and `ys`

In this directory, run:
```
make install PREFIX=~/.local
```

This will install `helmys` in `$PREFIX/bin/`.
It will also install the YS binary `ys` in `$PREFIX/bin/` if it is not already
there.

> **Note**: You can use any directory absolute path for `PREFIX` as long as it
> contains a `bin/` directory that is in your shell `PATH`.
> Also `ys` must be version `0.1.94` or higher.

You can also install each of these separately with:
```
make install-helmys PREFIX=~/.local
make install-ys PREFIX=~/.local
```


### Initializing your chart

Run:
```
helmys init <chart>
```

This will install the following 2 template files in your chart which is all
you'll need to start using YS code in your chart template files.

* `templates/helmys.yaml`

  Exposes the Helm builtin variables `Release`, `Values`, `Chart`, `Subcharts`,
  `Capabiities`, `Template` and `Files` as YS variables with the same names.

* `templates/helpers.yaml`

  A YS port of the default `_helpers.tpl` Go template file.
  This supports everything for the templates generated by `helm create`.
  You are encouraged to add your own functions and variables to it.


## Using `helm install ... --post-renderer=helmys`

Just add the `--post-renderer=helmys` option to your `helm install` (or `helm
template` or `helm upgrade`) commands.

```
$ helm install <name> <chart> --post-renderer=helmys
```

That's it!
It's really that simple!


### Using `helmys` instead of `helm`

For convenience you can use `helmys` instead of `helm` for all Helm commands.

> NOTE: That means you can use `alias helm=helmys` in your shell if you wish.

The `helmys` command will simply call `helm` with the same arguemnts.

For the `install`, `template` and `upgrade` commands it will add the
`--post-renderer=helmys` option.

This makes it easier and more natual to use HelmYS with the Helm CLI.


## Using HelmYS Hooks

You can set the `HELMYS_HOOKS` environment variable to a file (or URL) of YS
code that defines hook functions.

Currently there is only one hook function:

* `helmys-hook-out`

  This function is called with a data node of each post-rendered YAML document
  object.
  The function can return a different object that will replace the original.
  It can also return a `nil` value indicating that the original should not be
  changed.

  The resulting sequence of objects will then be converted to YAML which will
  be the final post-renderer output.


## Environment Variables

HelmYS has some environment variables that you might want to use.

These 3 are for debugging the YAML states during `helmys` post rendering.

* `HELMYS_HOOKS=<file-name>`
  See previous section.
* `HELMYS_DEBUG_INPUT=<file-name>`
  Name of a file to write the text that `helmys` read (from `helm`) on stdin.
* `HELMYS_DEBUG_THRUPUT=<file-name>`
  Name of a file to write the text after `helmys` altered it by moving the
  `helmys.yaml` template content to the front and adding the tags required by
  YS.
* `HELMYS_DEBUG_OUTPUT=<file-name>`
  Name of a file to write the text after `helmys` has evaluated everything as
  YS.


## Verifying that HelmYS doesn't change chart semantics

You can run a command like this to test if a Chart processed with HelmYS is
semantically equivalent to a chart processed without it:

```
$ ys -pe 'eq: ARGS.0:load ARGS.1:load' -- \
<(helm template my-chart) \
<(helm template my-chart --post-renderer=helmys)
true
```

If the command prints `true` the results are semantically equivalent.


## Try It Out

You can run `make test` which just runs the `test.sh` Bash script.

It creates a new Helm chart, runs `helmys init` on it, and then runs `helm
install` on it using the post-renderer and printing all the commands as it
goes.

Next it does the same thing with all the templates converted to YS.

It writes all the YAML rendering transition states in files under
`test/debug/`.


### `make clean`

Removes the files generated by `make test`.


## Status

The `helmys` post-renderer is in an ALPHA state, and being heavily tested.

At the present time, consider it a proof-of-concept that shows that YS can be
used with Helm 3.
Expects bugs, fixes and changes.

If you are interested in HelmYS please test it for us and report any bugs or
unexpected behaviors.

Remember you can use HelmYS with any amount of YS in your templates, including
no YS at all.


## License & Copyright

Copyright 2024-2025 Ingy dÃ¶t Net <ingy@ingy.net>

This project is licensed under the terms of the `MIT` license.
See the [License](https://github.com/kubeys/helmys/blob/main/License) file for
more details.
